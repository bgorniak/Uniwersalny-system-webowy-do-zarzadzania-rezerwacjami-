<!DOCTYPE html>
<html lang="pl">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moje rezerwacje</title>
    <link rel="stylesheet" href="{% static 'css/my_reservations.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="container">
        <header>
            <button onclick="window.location.href='/profile/'" class="back-button">Wróć</button>
            <h1>Moje rezerwacje</h1>
        </header>

        <main>
           <div class="reservation-list">
    {% for reservation in reservations %}
        <div class="reservation-item">
            <p><strong>Usługa:</strong> {{ reservation.service_name }}</p>
            <p><strong>Opcja:</strong> {{ reservation.option_name }}</p>
            <p><strong>Data rozpoczęcia:</strong> {{ reservation.start_date }}</p>
            {% if reservation.end_date %}
                <p><strong>Data zakończenia:</strong> {{ reservation.end_date }}</p>
            {% endif %}
            <p><strong>Status:</strong> <span class="status {{ reservation.status }}">{{ reservation.status }}</span></p>

            <div class="actions">
                {% if reservation.status != 'cancelled' %}
                    <button class="toggle-form-button" onclick="toggleForm('form-{{ reservation.id }}')">Zmień datę</button>
                    <form action="{% url 'cancel_reservation' reservation.id %}" method="post" class="cancel-form">
                        {% csrf_token %}
                        <button type="submit" class="cancel-button">Usuń rezerwację</button>
                    </form>
                {% endif %}
            </div>

            <div id="form-{{ reservation.id }}" class="change-date-form" style="display: none;">
                <form action="{% url 'request_change_date' reservation.id %}" method="post">
                    {% csrf_token %}
                    <label for="new_start_date-{{ reservation.id }}">Nowa data rozpoczęcia:</label>
                    <input type="text" id="new_start_date-{{ reservation.id }}" name="new_start_date"
       data-available-from="{{ reservation.available_from }}"
       data-available-to="{{ reservation.available_to }}" required>

{% if reservation.end_date %}
    <input type="text" id="new_end_date-{{ reservation.id }}" name="new_end_date"
           data-available-from="{{ reservation.available_from }}"
           data-available-to="{{ reservation.available_to }}">
{% endif %}
                    <button type="submit" class="submit-change-button">Zatwierdź zmianę</button>
                </form>
            </div>
        </div>
    {% endfor %}
</div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
     document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0]; // Dzisiejsza data w formacie ISO

    // Funkcja do inicjalizacji Flatpickr z zakresami dat
    function initFlatpickr(input) {
        const availableFrom = input.dataset.availableFrom || today; // Pobranie minimalnej daty
        const availableTo = input.dataset.availableTo || null;     // Pobranie maksymalnej daty

        flatpickr(input, {
            dateFormat: "Y-m-d",
            minDate: availableFrom,
            maxDate: availableTo,
            disableMobile: true,
        });
    }

    // Funkcja rozwijająca formularz i inicjalizująca Flatpickr
    function toggleForm(formId) {
        const form = document.getElementById(formId);

        if (form.style.display === 'none') {
            form.style.display = 'block';

            // Znajdź pola daty w formularzu i zainicjalizuj Flatpickr
            const startDateInput = form.querySelector('input[name="new_start_date"]');
            const endDateInput = form.querySelector('input[name="new_end_date"]');

            if (startDateInput) {
                initFlatpickr(startDateInput);
            }
            if (endDateInput) {
                initFlatpickr(endDateInput);
            }
        } else {
            form.style.display = 'none';
        }
    }

    // Przypisz funkcję toggleForm do każdego przycisku zmiany daty
    const toggleButtons = document.querySelectorAll('.toggle-form-button');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function () {
            const formId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            toggleForm(formId);
        });
    });
});



</script>


</body>
</html>
